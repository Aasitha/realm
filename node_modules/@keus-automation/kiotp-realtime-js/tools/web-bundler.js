const zx = require('fix-esm').require('zx');
const fs = require('fs');

const changeFileExportPath = async () => {
    let fileData = fs.readFileSync('./dist-web/nats-export.js', {encoding: 'utf-8'});
    fileData = fileData.replace(/\"nats\"/gi, '"nats.ws"');
    fs.writeFileSync('./dist-web/nats-export.js', fileData);

    fileData = fs.readFileSync('./dist-web/nats-export.d.ts', {encoding: 'utf-8'});
    fileData = fileData.replace(/\'nats\'/gi, "'nats.ws'");
    fs.writeFileSync('./dist-web/nats-export.d.ts', fileData);

    fileData = fs.readFileSync('./dist-web/nats-impl.d.ts', {encoding: 'utf-8'});
    fileData = fileData.replace('/// <reference types="node" />', "");
    fs.writeFileSync('./dist-web/nats-impl.d.ts', fileData);
};

const addWindowObjectExposure = async () => {
    let fileData = fs.readFileSync('./dist-web/index.js', {encoding: 'utf-8'});
    fileData = fileData + "window.KeusRealtimeCommunication = nats_impl_1.default;";
    fs.writeFileSync('./dist-web/index.js', fileData);
}

const updatePackageJSON = async () => {
    let packageFile = require('../package.json');
    console.log(packageFile);
    delete packageFile.dependencies.nats;
    packageFile.devDependencies = {};
    packageFile.scripts = {};
    packageFile.name = '@keus-automation/kiotp-realtime-js-web';
    packageFile.main = "./index.js";

    fs.writeFileSync('./dist-web/package.json', JSON.stringify(packageFile, null, 4));
}

(async () => {
    await zx.$`rm -rf ./dist-web/`;
    await zx.$`mkdir -p ./dist-web/`;
    await zx.$`cp -R ./dist/src/* ./dist-web/`;
    await changeFileExportPath();
    await addWindowObjectExposure();
    await zx.$`npx webpack --config ./tools/webpack.config.js`;
    await updatePackageJSON();
})();